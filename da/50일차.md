# Pipeline

*   LabelEncoder를 사용해서 target을 인코딩 -> y
*   features와 y(레이블)을 훈련 셋과 테스트 셋으로 구분(train_test_split).
*   ColumnTransformer 생성
    *   카테고리 타입 변수들에는 OneHotEncoder를 적용
    *   숫자 타입 변수들에는 StandardScaler를 적용
*   Estimator(ML 객체)를 생성
    *   LogisticRegression
*   Pipeline 객체 생성
    *   변환기(Transformer)와 예측기(Estimator)를 연결
*   Pipeline 훈련(fit), 평가(score)
    *   교차검증(cross_validate)
 

## Label Encoder

```python
label_enc = LabelEncoder()
```
```python
y = label_enc.fit_transform(target)  # 타겟 배열
```
```python
y.shape
```
<img width="55" height="30" alt="image" src="https://github.com/user-attachments/assets/21348ef2-2040-44f0-abde-4855abd49c5f" />

```python
y[:10]
```
<img width="275" height="35" alt="image" src="https://github.com/user-attachments/assets/fb1aa7fe-3f78-4ea9-99a0-7529cd24110c" />

```python
y[-10:]
```
<img width="272" height="34" alt="image" src="https://github.com/user-attachments/assets/607d337d-2dcc-4770-ba04-5dbaa2713a16" />

```python
np.unique(y, return_counts = True)
```
<img width="309" height="37" alt="image" src="https://github.com/user-attachments/assets/f891747c-58c7-4c0b-9e17-0561da38dc16" />

```python
label_enc.classes_  # 타겟 클래스 이름들
```
<img width="387" height="33" alt="image" src="https://github.com/user-attachments/assets/ca38e120-2bd8-4eda-b82d-9d965195a86b" />

## train/test 나누기
```python
X_tr, X_te, y_tr, y_te = train_test_split(features, y, test_size = 0.2, random_state = 42, stratify = y)
```
```python
X_tr.shape
```
<img width="72" height="28" alt="image" src="https://github.com/user-attachments/assets/29027f80-b488-4311-8ee7-d33eaa03f913" />

```python
X_te.shape
```
<img width="67" height="29" alt="image" src="https://github.com/user-attachments/assets/1fd53575-c6db-419e-97e1-4a5c63039722" />

```python
y_tr.shape
```
<img width="60" height="30" alt="image" src="https://github.com/user-attachments/assets/4b256478-7e29-4f77-9c5b-97c698e5aa89" />

```python
y_te.shape
```
<img width="54" height="34" alt="image" src="https://github.com/user-attachments/assets/4f5d7a09-327f-4f6d-b608-903769478b60" />

```python
X_tr.head()
```
<img width="684" height="191" alt="image" src="https://github.com/user-attachments/assets/ab49d98a-b0c9-4b1e-9669-3f6df8a71a71" />

```python
y_tr[:5]
```
<img width="170" height="26" alt="image" src="https://github.com/user-attachments/assets/42feec33-7f2a-4bb9-ad2d-cd7469e8cf46" />

```python
col_transformer = ColumnTransformer(transformers = [('enc', OneHotEncoder(), cat_cols),
                                                    ('scaler', StandardScaler(), num_cols)]
```
```python
logistic_reg = LogisticRegression(n_jobs = -1)
```

## Pipeline


Transformer + Estimator --> 훈련 셋 변환/훈련


```python
pipe = Pipeline(steps = [('trans', col_transformer),
                         ('clf', logistic_reg)])
```

## ML 모델 훈련, 평가

```python
pipe.fit(X_tr, y_tr)    # 모델 훈련
```
<img width="436" height="243" alt="image" src="https://github.com/user-attachments/assets/15f673b6-a1a8-4482-a78a-8d6bcdf46cef" />

```python
pipe['trans'].named_transformers_['enc'].categories_    # 카테고리 이름들
```
<img width="407" height="48" alt="image" src="https://github.com/user-attachments/assets/93da51b0-234c-4629-85dc-0f76b237fd54" />

```python
pipe['trans'].named_transformers_['scaler'].mean_   # 숫자 타입 변수(특성)의 평균들
```
<img width="494" height="30" alt="image" src="https://github.com/user-attachments/assets/d9a600bf-f3a3-4165-ae3c-b5365983a2da" />

```python
pipe['trans'].named_transformers_['scaler'].var_    # 숫자 타입 변수(특성)의 분산들
```
<img width="510" height="30" alt="image" src="https://github.com/user-attachments/assets/38f10f90-820a-4df9-b602-833548814277" />

```python
pipe['clf'].coef_     # 학습을 통해 찾은 Logistic Regression의 선형 회귀 계수들
# coef_의 shape: (n_classes, n_features)
```
<img width="522" height="117" alt="image" src="https://github.com/user-attachments/assets/2238fbd0-4768-411e-bfb2-a4158b252a3e" />

```python
pipe['clf'].intercept_      # 학습을 통해 찾은 Logistic Regression의 절편들
# intercept_의 shape: (n_classes,)
```
<img width="338" height="31" alt="image" src="https://github.com/user-attachments/assets/bc98deb7-d0a3-4393-88cf-8c6556a9b828" />

```python
tr_pred = pipe.predict(X_tr)    # 훈련 셋의 예측값
```
```python
tr_pred[:10]
```
<img width="274" height="30" alt="image" src="https://github.com/user-attachments/assets/799f833a-ffaa-46c3-917a-4d0b1717859e" />

```python
y_tr[:10]   # 실제 값
```
<img width="274" height="33" alt="image" src="https://github.com/user-attachments/assets/1a341e26-2a3f-4c14-a6b6-0b417a0ebbe6" />

```python
cm = confusion_matrix(y_tr, tr_pred)
cm
```
<img width="183" height="61" alt="image" src="https://github.com/user-attachments/assets/d940a995-60cd-4b7d-bf0d-2af49ab44d4b" />

```python
sns.heatmap(data = cm, annot = True, fmt = 'd', cmap = 'Blues', 
            xticklabels = label_enc.classes_,
            yticklabels = label_enc.classes_)
plt.show()
```
<img width="522" height="420" alt="image" src="https://github.com/user-attachments/assets/801a481e-23e6-49c1-aa19-8ffe2ba94c06" />

```python
print(classification_report(y_tr, tr_pred))
```
<img width="392" height="172" alt="image" src="https://github.com/user-attachments/assets/bb035967-f149-422d-9310-89654847d76f" />

```
266/267 -> 0.9962546816479401
```

```python
te_pred = pip.predict(X_te)  # 테스트 셋 예측값
```
```python
cm_test = confusion_matrix(y_te, te_pred)
cm_test
```
<img width="159" height="61" alt="image" src="https://github.com/user-attachments/assets/9aeb8dd2-856c-4842-9f49-1abf87f81925" />

```python
sns.heatmap(data = cm_test, cmap = 'Blues', annot = True, fmt = 'd',  # fmt = 'd' -> 정수로 값을 표시
            xticklabels = label_enc.classes_,
            yticklabels = label_enc.classes_)
plt.show()
```
<img width="523" height="416" alt="image" src="https://github.com/user-attachments/assets/5c658656-4ef4-4937-b721-af74dae83028" />

```python
print(classification_report(y_te, te_pred))
```
<img width="390" height="166" alt="image" src="https://github.com/user-attachments/assets/9b6e205c-1e74-4453-8701-fb843c90131e" />


-------------------

# MNIST 데이터셋 이미지 분류

# Imports
```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt     # plt.plot(), ... 함수 사용하기 위해서
from matplotlib import image    # image.imsave(), image.imread(), ... 함수 사용하기 위해서
import seaborn as sns

from sklearn import datasets
from sklearn.model_selection import train_test_split, cross_validate
from sklearn.linear_model import LogisticRegression, SGDClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.svm import LinearSVC, SVC      # 선형, 비선형 
from sklearn.metrics import confusion_matrix, classification_report
```

# Python에서 이미지 다루기

```python
china = datasets.load_sample_image('china.jpg')     # jpg가 아니라 ndarray
# 이미지 파일(jpg, png, ...) 읽어서 3차원 배열을 리턴.
```
```python
type(china)
```
<img width="110" height="25" alt="image" src="https://github.com/user-attachments/assets/742b4270-776f-4d2f-9677-d91daaed8ded" />

```python
china.shape  # 이미지의 세로 길이, 이미지의 가로 길이, RGB 3가지 색상
```
<img width="111" height="27" alt="image" src="https://github.com/user-attachments/assets/9cdf5fb7-3154-41ca-9810-06689d824460" />

```python
plt.inshow(china)  # 이미지 시각화
plt.show()  # 실제로 화면에 표시
```
<img width="561" height="382" alt="image" src="https://github.com/user-attachments/assets/32361684-2f90-43e2-85e8-5a93707313a6" />

```python
china
```
<img width="310" height="899" alt="image" src="https://github.com/user-attachments/assets/a4e79d1e-06a0-4d48-890c-78861708e987" />


이미지 numpy ndarray

*   흑백 이미지인 경우, 이미지 배열의 shape: (height, width)
*   컬러 이미지인 경우, 
    *   불투명한 경우, 이미지 배열의 shape: (height, width, 3) --> 3: RGB
    *   투명도가 있는 경우, 이미지 배열의 shape: (height, width, 4) --> 4: RGBA
*   이미지 배열의 숫자 스케일
    *   0 ~ 255 정수 --> (2^8 = 256)
    *   0.0 ~ 1.0 실수

*   matplotlib.image.imsave(fname, arr):
    *   파일 fname에 이미지 배열 arr을 이미지 형식(jpg, png, ...)으로 변환해서 저장.
    *   ndarray --> jpg
*   matplotlib.image.imread(fname)
    *   이미지 파일 fname에서 이미지를 읽고 배열을 리턴.
    *   jpg --> ndarray
 

```python
image.imsave('china_copy.jpg', china)   # 폴더에 jpg로 저장됨
```
```python
img_arr = image.imread('china_copy.jpg')    # jpg가져와서 ndarray로 만들어줌
```
```python
type(img_arr)
```
<img width="113" height="26" alt="image" src="https://github.com/user-attachments/assets/8b9ab741-e83a-4edc-92ee-5c3bfee7d289" />


이미지 배열에서 특정 색상(R/G/B) 제거


```python
img_arr_copy = img_arr.copy()
img_arr_copy[:, :, 2] = 0   # Blue 색상을 제거
plt.imshow(img_arr_copy)
plt.show()
```
<img width="557" height="380" alt="image" src="https://github.com/user-attachments/assets/27e44127-9e17-4fa3-a211-88c4f3cd9b72" />


이미지 자르기 - 배열 slicing


```python
img_crop = img_arr[:240, :320, :]
plt.imshow(img_crop)
plt.show()
```
<img width="563" height="416" alt="image" src="https://github.com/user-attachments/assets/ace5560c-858a-4630-be2a-82e32c0464fb" />

# MNIST 데이터셋


70,000개의 흑백 이미지(28X28)가 numpy 배열로 저장된 데이터 셋.


```python
mnist = datasets.fetch_openml('mnist_784')
```
```python
print(type(mnist))   # scikit-learn Bunch 클래스: dict 비슷
```
<img width="265" height="24" alt="image" src="https://github.com/user-attachments/assets/17f0d9e7-b200-45e2-9388-0a2bfcd10598" />

```python
mnist.keys()
```
<img width="799" height="38" alt="image" src="https://github.com/user-attachments/assets/26d54637-aa8e-404a-9a49-1b184c2c81d7" />

```python
mnist.data   # (n_samples, n_features) = (70_000, 784) 모양의 데이터프레임
```
<img width="1515" height="404" alt="image" src="https://github.com/user-attachments/assets/86cc1122-5670-4db4-8989-20798b540208" />

```python
mnist.target   # (n_sample,) = (70_000,) 모양의 시리즈.
```
<img width="182" height="445" alt="image" src="https://github.com/user-attachments/assets/79499269-89b8-4dd9-8a88-274163cc3c51" />

```python
X = mnist.data.values.copy()   # 특성 배열
y = mnist.target.values.copy()   # 타겟 배열
```
```python
X.shape
```
<img width="101" height="29" alt="image" src="https://github.com/user-attachments/assets/46bb111c-958f-4c0b-b4d6-e273d946edca" />

```python
y.shape
```
<img width="68" height="33" alt="image" src="https://github.com/user-attachments/assets/793eebbc-6951-44ff-9e2f-876f83cfdc2a" />

## MNIST 데이터 시각화
```python
image_0 = X[0].reshape((28, 28))
image_0
```
```
array([[  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   3,
         18,  18,  18, 126, 136, 175,  26, 166, 255, 247, 127,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,  30,  36,  94, 154, 170,
        253, 253, 253, 253, 253, 225, 172, 253, 242, 195,  64,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,  49, 238, 253, 253, 253, 253,
        253, 253, 253, 253, 251,  93,  82,  82,  56,  39,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,  18, 219, 253, 253, 253, 253,
        253, 198, 182, 247, 241,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,  80, 156, 107, 253, 253,
        205,  11,   0,  43, 154,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,  14,   1, 154, 253,
         90,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 139, 253,
        190,   2,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  11, 190,
        253,  70,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  35,
        241, 225, 160, 108,   1,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
         81, 240, 253, 253, 119,  25,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,  45, 186, 253, 253, 150,  27,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,  16,  93, 252, 253, 187,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0, 249, 253, 249,  64,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,  46, 130, 183, 253, 253, 207,   2,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  39,
        148, 229, 253, 253, 253, 250, 182,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  24, 114, 221,
        253, 253, 253, 253, 201,  78,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,  23,  66, 213, 253, 253,
        253, 253, 198,  81,   2,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,  18, 171, 219, 253, 253, 253, 253,
        195,  80,   9,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,  55, 172, 226, 253, 253, 253, 253, 244, 133,
         11,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0, 136, 253, 253, 253, 212, 135, 132,  16,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0]])
```

```python
plt.imshow(image_0)
plt.show()
```
<img width="420" height="412" alt="image" src="https://github.com/user-attachments/assets/e9c6b3dd-bb91-45df-b83f-bf9b400b8222" />

```python
plt.imshow(image_0, cmap = plt.cm.gray)
plt.show()
```
<img width="412" height="415" alt="image" src="https://github.com/user-attachments/assets/5e161c96-3145-4c16-8b41-99f996ca19bf" />

