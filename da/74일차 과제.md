# CNN  연습

*   Keras 패키지의 손글씨 MNIST 예제 데이터셋을 다운로드하세요.
*   예제 데이터셋의 일부(예: 100개)를 시각화해 보세요.
*   훈련 셋과 테스트 셋의 데이터는 0. ~ 1. 스케일로 스케일링하세요.
*   전체 훈련 셋은 다시 훈련 셋과 검증 셋으로 나누세요.
*   아래의 CNN 모델 구조처럼 합성곱 신경망을 설계하세요.
*   모든 합성곱 층의 커널 사이즈는 3으로 설정하세요.
*   모든 합성곱 층(Conv2D)와 출력층을 제외한 밀집층(Dense)에서
    *   활성화 함수는 ReLU로 설정하세요.
    *   커널 초기화 함수(kernel initializer)를 'he_normal'로 설정하세요.
*   첫번째 Dropout 층의 rate는 0.25로 설정하세요.
*   두번째 Dropout 층의 rate는 0.5로 설정하세요.
*   모델의 옵티마이저(optimizer)는 Nadam을 사용하세요.
*   ModelCheckpoint, EarlyStopping 콜백들과 검증 셋을 함께 사용해서 모델을 훈련하세요.
    *   최적의 모델은 cnn_ex_best.keras 파일로 저장하세요.
*   모델의 성능을 평가하세요.

---

__CNN example__

<img src="https://raw.githubusercontent.com/JakeOh/202505_BD50/refs/heads/main/lab_da/cnn_example_64dpi.png" alt="CNN example" />


------- 내가 푼거
# Imports

```python
import numpy as np
import matplotlib.pyplot as plt
from sklearn import datasets
import tensorflow as tf
import keras
```

# MNIST 데이터 셋

```python
mnist = datasets.fetch_openml('mnist_784')
```
```python
X = mnist.data.values.copy()
y = mnist.target.values.copy()
```

# 예제 데이터셋의 일부(예: 100개)를 시각화

```python
fig, axes = plt.subplots(nrows = 10, ncols = 10)
for i in range(10):
    for j in range(10):
        img = X[i * 10 + j].reshape((28, 28))
        axes[i][j].imshow(img, cmap = 'binary')
        axes[i][j].axis('off')

plt.show()
```
<img width="505" height="389" alt="image" src="https://github.com/user-attachments/assets/5c9ed4a7-b7f1-416a-bee7-19bb3e7ef808" />

# 훈련 셋/테스트 셋 나누기

```python
X_tr, X_te, y_tr, y_te = train_test_split(X, y, test_size = 10_000, stratify = y, random_state=42)
```
```python
print(X_tr.shape)
print(y_tr.shape)
print(X_te.shape)
print(y_te.shape)
```
<img width="96" height="74" alt="image" src="https://github.com/user-attachments/assets/7b7e1b89-8d5d-4cbe-b81e-19b7123f47d7" />

# 훈련 셋과 테스트 셋의 데이터는 0. ~ 1. 스케일로 스케일링

```python
X_tr_scaled = X_tr.reshape((-1, 28, 28, 1)) / 255.0
X_te_scaled = X_te.reshape((-1, 28, 28, 1)) / 255.0
```

# 전체 훈련 셋은 다시 훈련 셋과 검증 셋으로 나누기

```python
X_train, X_val, y_train, y_val = train_test_split(X_tr_scaled, y_tr, test_size = 0.2, stratify = y_tr)
```
```python
y_train = y_train.astype(np.int32)
y_val = y_val.astype(np.int32)
y_te = y_te.astype(np.int32)
```
```python
print(X_train.shape)
print(X_val.shape)
```
<img width="143" height="41" alt="image" src="https://github.com/user-attachments/assets/e4b5bb22-f019-4423-87cc-382a2f631f96" />

```python
model = keras.Sequential()
```
```python
inputs = keras.Input(shape = (28, 28, 1))
model.add(inputs)
```
```python
conv_1 = keras.layers.Conv2D(filters = 32, kernel_size = 3,
                             padding = 'same', activation = 'relu', kernel_initializer = 'he_normal')
model.add(conv_1)
```
```python
conv_2 = keras.layers.Conv2D(filters = 64, kernel_size = 3,
                             padding = 'same', activation = 'relu', kernel_initializer = 'he_normal')
model.add(conv_2)
```
```python
max_pool_1 = keras.layers.MaxPool2D()
model.add(max_pool_1)
```
```python
model.add(keras.layers.Flatten())
```
```python
model.add(keras.layers.Dropout(rate = 0.25))
```
```python
dense_1 = keras.layers.Dense(units = 128, activation='relu', kernel_initializer = 'he_normal')
model.add(dense_1)
```
```python
model.add(keras.layers.Dropout(rate = 0.5))
```
```python
dense_2 = keras.layers.Dense(units = 10, activation='softmax')
model.add(dense_2)
```
```python
model.summary()
```
<img width="559" height="353" alt="image" src="https://github.com/user-attachments/assets/ea72ff1d-34ae-4514-aeae-46f0791a1859" />

```python
keras.utils.plot_model(model, dpi = 64, show_shapes = True)
```
<img width="399" height="828" alt="image" src="https://github.com/user-attachments/assets/3ae8a3db-6dd9-465a-9696-c7243369de0c" />

```python
model.compile(optimizer = keras.optimizers.Nadam(),
              loss = keras.losses.sparse_categorical_crossentropy,
              metrics = [keras.metrics.sparse_categorical_accuracy])
```
```python
dir_path = '/content/drive/MyDrive/Colab Notebooks/lab_da/'
model_file = dir_path + 'cnn_ex_best.keras'

checkpoint = keras.callbacks.ModelCheckpoint(model_file, save_best_only=True)
early_stop = keras.callbacks.EarlyStopping(patience = 3, restore_best_weights = True)
```
```python
result = model.fit(x = X_train, y = y_train, epochs = 100,
                   callbacks = [checkpoint, early_stop],
                   validation_data = [X_val, y_val])
```
<img width="1280" height="261" alt="image" src="https://github.com/user-attachments/assets/562d5e78-717f-4ce6-8cc8-c4ce327bcdea" />

# 모델 평가

```python
model.evaluate(x = X_train, y = y_train)
```
<img width="849" height="46" alt="image" src="https://github.com/user-attachments/assets/e790c196-f310-40e5-821d-a342115b0be6" />

```python
model.evaluate(x = X_val, y = y_val)
```
<img width="822" height="37" alt="image" src="https://github.com/user-attachments/assets/98994b8e-3c20-40c6-a702-4fa0690c9fa5" />



------- 풀이
# Import

```python
import numpy as np
import matplotlib.pyplot as plt

from sklearn.model_selection import train_test_split

import tensorflow as tf
import keras
```
```python
tf.config.list_physical_devices()
```
<img width="473" height="27" alt="image" src="https://github.com/user-attachments/assets/1b97bec9-5381-4796-97f2-39bf67ee2592" />

# MNIST Datasets

```python
(x_train_full, y_train_full), (x_test, y_test) = keras.datasets.mnist.load_data()
```
<img width="668" height="44" alt="image" src="https://github.com/user-attachments/assets/27581b8e-133c-4eb3-a54a-18b6355f95dc" />

```python
print(x_train_full.shape)
print(y_train_full.shape)
print(x_test.shape)
print(y_test.shape)
```
```python
np.unique(y_train_full, return_counts = True)  # 고유한 값들을 찾고, 각 고유한 값이 몇 번 나타나는 지
```
<img width="498" height="43" alt="image" src="https://github.com/user-attachments/assets/bb933130-e689-4109-8210-b33d1e9620b1" />

```python
np.unique(y_test, return_counts = True)
```
<img width="499" height="47" alt="image" src="https://github.com/user-attachments/assets/ac0c28fd-d523-40bc-825c-5105736a1aa6" />

```python
def plot_mnist_image(arr, ncols = 10):  # ncols = 10 한 줄에 이미지 10개
    # arr: (n_samples, height, width) 또는 (n_samples, height, width, n_channels) 모양의 배열.
    n_samples = len(arr)
    nrows = int(np.ceil(n_samples / ncols))  # 올림
    fig, ax = plt.subplots(nrows = nrows, ncols = ncols, figsize = (ncols, nrows))  # figsize는 width, height 순서로 줘야함
    for i in range(nrows):
        for j in range(ncols):
            idx = i * ncols + j
            if nrows == 1 or ncols == 1:
                if idx < n_samples:
                    ax[idx].imshow(arr[idx], cmap = plt.cm.binary)
                ax[idx].axis('off')
            else:
                if idx < n_samples:
                    ax[i, j].imshow(arr[idx], cmap = plt.cm.binary)
                ax[i, j].axis('off')
    plt.show()
```
```python
plot_mnist_image(x_train_full[:50])
```
<img width="794" height="404" alt="image" src="https://github.com/user-attachments/assets/8a5934cb-ab40-4fca-ad91-2ec52aa8e402" />

```python
plot_mnist_image(x_test[:3], ncols = 1)
```
<img width="87" height="251" alt="image" src="https://github.com/user-attachments/assets/76b22598-6ede-4453-901e-0e20a41d31f4" />


# 데이터 셋 reshape & scaling

*   이미지 분류 합성곱 신경망에서는 이미지 배열의 모양이 (n_samples, height, width, n_channel)인 3차원 배열이라고 가정.
*   0. ~ 1. 실수 범위인 경우가 성능이 좋음.


```python
np.max(x_train_full[0]), np.min(x_train_full[0])
# 첫번째 이미지 픽셀의 최댓값, 최소값 -> 0 ~ 255 사이의 부호 없는 8비트 정수.
```
<img width="204" height="30" alt="image" src="https://github.com/user-attachments/assets/89190731-f111-4a9c-83bd-4a943255bd7f" />

```python
x_train_full_scaled = x_train_full.reshape((-1, 28, 28, 1)) / 255.
x_test_scaled = x_test.reshape((-1, 28, 28, 1)) / 255.
```
```python
x_train_full_scaled.shape
```
<img width="141" height="29" alt="image" src="https://github.com/user-attachments/assets/634c10c9-b2d7-475d-9e01-ce65dd2abb26" />

```python
np.max(x_train_full_scaled), np.min(x_train_full_scaled)
```
<img width="254" height="32" alt="image" src="https://github.com/user-attachments/assets/fc26db95-ab4c-48c9-bfc3-c82b8ec21a48" />

# 훈련/검증 셋 분리

```python
x_train, x_val, y_train, y_val = train_test_split(x_train_full_scaled, y_train_full,
                                                  test_size = 0.1,
                                                  stratify = y_train_full,
                                                  random_state = 42)
```
```python
x_train.shape
```
<img width="139" height="27" alt="image" src="https://github.com/user-attachments/assets/cab8f7d3-b5d1-41e2-9a3b-141e5fdf4685" />

# 합성곱 신경망 생성

```python
tf.random.set_seed(42)
np.random.seed(42)

model = keras.Sequential(layers = [
    keras.Input(shape = (28, 28, 1)),  # 입력층
    keras.layers.Conv2D(filters = 32, kernel_size = 3, padding = 'same',  # filters의 갯수만큼 output이 나옴
                        activation = 'relu', kernel_initializer = 'he_normal'),  # kernel_initializer -> 커널 초기화해주는 함수. 첫번째 합성곱
    keras.layers.conv2D(filters = 64, kernel_size = 3, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),  # 두번째 합성곱
    keras.layers.MaxPool2D(),  # Max Pooling
    keras.layers.Flatten(),
    keras.layers.Dropout(rate = 0.25),
    keras.layers.Dense(units = 128, activation = 'relu', kernel_initializer = 'he_normal'),  # 밀집층
    keras.layers.Dropout(rate = 0.5),
    keras.layers.Dense(units = 10, activation = 'softmax')  # 마지막 dense들은 나가는 값들만 있으면 되기 때문에 kernel_initializer를 설정하지 않음

])
```
```python
model.summary()
```
<img width="555" height="355" alt="image" src="https://github.com/user-attachments/assets/a4204539-77a5-41f9-bc7f-715b0db2fd31" />

```
(3 * 3 + 1) * 32 = 320
(3 * 3 * 32 + 1) * 64 = 18,496 -> bias = 1, filters = 64
14 * 14 * 64 = 12544 -> 세로 * 가로 * 채널수
(12944 + 1) * 128 = 1,605,760 -> bias = 1, units = 128
(128 + 1) * 10 = 1,290

메모리 계산
4 *  1625866 / 1024 / 1024 = 6.2021... -> 4바이트 
```

# 모델 훈련

```python
# 모델 컴파일(최적화함수, 손실함수, 평가지표)
model.compile(optimizer = 'nadam',
              loss = keras.losses.sparse_categorical_crossentropy,
              metrics = [keras.metrics.sparse_categorical_accuracy)
```
```python
from datetime import datetime

dir_path = '/content/drive/MyDrive/Colab Notebooks/lab_da/'
file_name = 'cnn_ex_best'
time_suffix = datetime.now().strftime('_%Y%m%d%H%M%S')    # 현재 시간 정보
file_path = f'{dir_path}{file_name}{time_suffix}.keras'

print(file_path)
```
<img width="564" height="30" alt="image" src="https://github.com/user-attachments/assets/2fc6622e-f2c7-4f4c-8c1c-11fe65b448d6" />

```python
checkpoint = keras.callbacks.ModelCheckpoint(filepath = file_path, save_best_only = True)
early_stop = keras.callbacks.EarlyStopping(patience = 2)
```
```python
result = model.fit(x = x_train, y = y_train, epochs = 100,
                    callbacks = [checkpoint, early_stop],
                    validation_data = [x_val, y_val])
```
<img width="1276" height="138" alt="image" src="https://github.com/user-attachments/assets/3d6b0161-1d69-4a02-acfe-9b21decbeae1" />

```python
def plot_train_val_loss(history):
    # history: keras의 History 클래스 타입 객체. fit 메서드의 리턴 값.
    epochs = history.epoch
    history = history.history
    plt.plot(epochs, history['loss'], 'bo-', label = 'train loss')
    plt.plot(epochs, history['val_loss'], 'ro:', label = 'validation loss')
    plt.legend()
    plt.grid()
    plt.xlabel('epoch')
    plt.ylabel('loss')
    plt.show()
```
```python
plot_train_val_loss(result)
```
<img width="576" height="432" alt="image" src="https://github.com/user-attachments/assets/771cd967-4c15-43f5-b397-462d89a9cd00" />

# 모델 평가

```python
model.evaluate(x = x_train, y = y_train)    # 훈련 셋 손실/정확도
```
<img width="831" height="43" alt="image" src="https://github.com/user-attachments/assets/62ef73ba-4b02-4ae6-901a-d3948ed547aa" />

```python
model.evaluate(x = x_val, y = y_val)    # 검증 셋 손실/정확도
```
<img width="818" height="45" alt="image" src="https://github.com/user-attachments/assets/c1add540-e6f1-4a68-9c81-80a91861747f" />

```python
model.evaluate(x = x_test_scaled, y = y_test)   # 테스트 셋 손실/정확도
```
<img width="820" height="44" alt="image" src="https://github.com/user-attachments/assets/e8559272-f4e3-470c-8e29-47fa9cbda7e3" />

--------------------------

# CNN 연습 2

*   Fashion MNIST 데이터 셋
*   CNN 구조
    *   Conv2D(filters = 64, kernel_size = 7)
    *   MaxPool2D
    *   Conv2D(filters = 128, kernel_size = 3)
    *   Conv2D(filters = 128, kernel_size = 3)
    *   MaxPool2D
    *   Conv2D(filters = 256, kernel_size = 3)
    *   Conv2D(filters = 256, kernel_size = 3)
    *   MaxPool2D
    *   Flatten
    *   Dense(units = 128)
    *   Dropout(rate = 0.5)
    *   Dense(units = 64)
    *   Dropout(rate = 0.5)
    *   Dense(units = 10) - 출력층(units 수 알아서 정하기)
    *   출력층을 제외한 층(Conv2D, Dense)들의 활성화 함수는 relu
    *   합성곱은 same 패딩 방식.
    *   커널 초기화 함수 'he_normal'
 
```python
(x_train_full, y_train_full), (x_test, y_test) = keras.datasets.fashion_mnist.load_data()
```
<img width="804" height="138" alt="image" src="https://github.com/user-attachments/assets/1be51b41-9b3d-4210-aacb-87438bf57661" />

```python
print(x_train_full.shape)
print(y_train_full.shape)
print(x_test.shape)
print(y_test.shape)
```
<img width="120" height="77" alt="image" src="https://github.com/user-attachments/assets/fdc8dab1-d4f5-4884-9d01-7417e7f2778a" />

```python
np.unique(y_train_full, return_counts = True)
```
<img width="498" height="42" alt="image" src="https://github.com/user-attachments/assets/a96259cd-41d2-4370-81e8-bd8cacf788e3" />

```python
np.unique(y_test, return_counts = True)
```
<img width="504" height="43" alt="image" src="https://github.com/user-attachments/assets/385025b4-7cf6-4743-937c-ab2e3c06bc66" />

```python
def plot_mnist_fashion_image(arr, ncols=10):
    n_samples = len(arr)
    nrows = int(np.ceil(n_samples / ncols))
    fig, ax = plt.subplots(nrows=nrows, ncols=ncols, figsize=(ncols, nrows))
    for i in range(nrows):
        for j in range(ncols):
            idx = i * ncols + j
            if nrows == 1 or ncols == 1:
                if idx < n_samples:
                    ax[idx].imshow(arr[idx], cmap=plt.cm.binary)
                ax[idx].axis('off')
            else:
                if idx < n_samples:
                    ax[i, j].imshow(arr[idx], cmap=plt.cm.binary)
                ax[i, j].axis('off')
    plt.show()
```
```python
plot_mnist_fashion_image(x_train_full[:50])
```
<img width="794" height="404" alt="image" src="https://github.com/user-attachments/assets/2da44346-cb7a-4a0c-a23d-59b41a77b4fd" />

```python
x_train_full_scaled = x_train_full.reshape((-1, 28, 28, 1)) / 255.
x_test_scaled = x_test.reshape((-1, 28, 28, 1)) / 255.
```
```python
x_train, x_val, y_train, y_val = train_test_split(x_train_full_scaled, y_train_full,
                                                  test_size = 0.1,
                                                  stratify = y_train_full,
                                                  random_state = 42)
```
```python
tf.random.set_seed(42)
np.random.seed(42)

model = keras.Sequential(layers = [
    keras.Input(shape = (28, 28, 1)),
    keras.layers.Conv2D(filters = 64, kernel_size = 7, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),
    keras.layers.MaxPool2D(),
    keras.layers.Conv2D(filters = 128, kernel_size = 3, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),
    keras.layers.Conv2D(filters = 128, kernel_size = 3, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),
    keras.layers.MaxPool2D(),
    keras.layers.Conv2D(filters = 256, kernel_size = 3, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),
    keras.layers.Conv2D(filters = 256, kernel_size = 3, padding = 'same',
                        activation = 'relu', kernel_initializer = 'he_normal'),
    keras.layers.MaxPool2D(),
    keras.layers.Flatten(),
    keras.layers.Dense(units = 128, activation = 'relu', kernel_initializer= 'he_normal'),
    keras.layers.Dropout(rate = 0.5),
    keras.layers.Dense(units = 64, activation = 'relu', kernel_initializer= 'he_normal'),
    keras.layers.Dropout(rate = 0.5),
    keras.layers.Dense(units = 10, activation = 'softmax')                           
])
```
```python
model.summary()
```
<img width="570" height="535" alt="image" src="https://github.com/user-attachments/assets/baa48e62-8318-4039-93ed-c174013aeaee" />

```python
keras.utils.plot_model(model, show_shapes = Ture, dpi = 64)
```
<img width="412" height="1468" alt="image" src="https://github.com/user-attachments/assets/63298748-b0d4-4109-a79f-0fb4a56bcf54" />

```python
model.compile(optimizer = keras.optimizers.Nadam(),
              loss = keras.losses.sparse_categorical_crossentropy,
              metrics = [keras.metrics.sparse_categorical_accuracy])
```
```python
from datetime import datetime

dir_path = '/content/drive/MyDrive/Colab Notebooks/lab_da/'
file_name = 'cnn_ex_fashion_best'
time_suffix = datetime.now().strftime('_%Y%m%d%H%M%S')
file_path = f'{dir_path}{file_name}{time_suffix}.keras'

print(file_path)
```
<img width="627" height="27" alt="image" src="https://github.com/user-attachments/assets/653db450-7e87-46fd-97c3-7e78c575d3df" />

```python
checkpoint = keras.callbacks.ModelCheckpoint(filepath = file_path, save_best_only = True)
early_stop = keras.callbacks.EarlyStopping(patience=2, restore_best_weights=True)
```
```python
result = model.fit(x = x_train, y = y_train, epochs = 100,
                   callbacks = [checkpoint, early_stop],
                   validation_data = [x_val, y_val])
```
<img width="1268" height="169" alt="image" src="https://github.com/user-attachments/assets/00b7558d-63bf-4ba3-893f-8dcc74187753" />

```python
plot_train_val_loss(result)
```
<img width="567" height="432" alt="image" src="https://github.com/user-attachments/assets/501b1432-45c7-4c43-8025-7577c03e8d04" />

```python
model.evaluate(x_train, y_train)
```
<img width="827" height="45" alt="image" src="https://github.com/user-attachments/assets/d11b3632-69b9-431f-83d4-bd1607ef3214" />

```python
model.evaluate(x_val, y_val)
```
<img width="820" height="45" alt="image" src="https://github.com/user-attachments/assets/d167f280-8985-46de-98ee-ed7e71e609d8" />

```python
model.evaluate(x_test_scaled, y_test)
```
<img width="818" height="40" alt="image" src="https://github.com/user-attachments/assets/487fb9a3-6ca0-43d6-ada4-887a0c155761" />
